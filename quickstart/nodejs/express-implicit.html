<!DOCTYPE html>
<html class="no-js" lang="en" dir="ltr">
<body>
    <p>In the Generic Node example (see other tab) we show you how to use the simplified <a href="https://www.npmjs.com/package/@okta/jwt-verifier">Okta JWT Verifier</a> to verify Oktaâ€™s JWTs.  In the example below we use the same verifier to create a simple Express middleware function that can prevent a request from completing if the request is not authenticated with a valid access token.  To learn more about validating Okta access tokens, please see <a href="https://developer.okta.com/standards/OAuth/index#validating-access-tokens">Validating Access Tokens</a>.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">OktaJwtVerifier</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'@okta/jwt-verifier'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">cors</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cors'</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">oktaJwtVerifier</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OktaJwtVerifier</span><span class="p">({</span>
  <span class="na">issuer</span><span class="p">:</span> <span class="s1">'http://{yourOktaDomain}.com/oauth2/default'</span><span class="p">,</span>
  <span class="na">assertClaims</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">aud</span><span class="p">:</span> <span class="s1">'api://default'</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">});</span>

<span class="cm">/**
 * A simple middleware that asserts valid access tokens and sends 401 responses
 * if the token is not present or fails validation.  If the token is valid its
 * contents are attached to req.jwt
 */</span>
<span class="kd">function</span> <span class="nx">authenticationRequired</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">authHeader</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">authorization</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">authHeader</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Bearer </span><span class="se">(</span><span class="sr">.+</span><span class="se">)</span><span class="sr">/</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">end</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kr">const</span> <span class="nx">accessToken</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="k">return</span> <span class="nx">oktaJwtVerifier</span><span class="p">.</span><span class="nx">verifyAccessToken</span><span class="p">(</span><span class="nx">accessToken</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">jwt</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">jwt</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">;</span>
      <span class="nx">next</span><span class="p">();</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">401</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="cm">/**
 * For local testing only!  Enables CORS for all domains
 */</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cors</span><span class="p">());</span>

<span class="cm">/**
 * An example route that requires a valid access token for authentication, it
 * will echo the contents of the access token if the middleware successfully
 * validated the token.
 */</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/secure'</span><span class="p">,</span> <span class="nx">authenticationRequired</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">jwt</span><span class="p">);</span>
<span class="p">});</span>

<span class="cm">/**
 * Another example route that requires a valid access token for authentication, and
 * print some messages for the user if they are authenticated
 */</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/api/messages'</span><span class="p">,</span> <span class="nx">authenticationRequired</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">([{</span>
    <span class="na">message</span><span class="p">:</span> <span class="s1">'Hello, word!'</span>
  <span class="p">}]);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Serve Ready on port 3000'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
</div>

</body>
</html>
