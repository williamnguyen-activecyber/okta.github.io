<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6 no-flexbox"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-flexbox"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-flexbox"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-flexbox"> <![endif]-->
<!--[if IE 10 ]>    <html class="ie10 no-flexbox"> <![endif]-->
<!--[if (gt IE 10)|!(IE)]><!--> <html class="modern wf-loading" lang="en"> <!--<![endif]-->
  <head>
  <script>
    var searchDomain = 'https://developer.okta.com';
    var isProduction = window.location.hostname === 'developer.okta.com';
    if (isProduction) {
      // TypeKit
      (function(d) {
        var config = {
          kitId: 'jff5neq',
          scriptTimeout: 3000,
          async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/bwf-loadingb/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);

      // Google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-15777010-3', 'auto');
      ga('send', 'pageview');

      // START Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TJ45R6');
      // END Google Tag Manager
    }
	</script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
 	

  <link type="text/css" rel="stylesheet" href="https://developer.okta.com/sites/all/themes/developer/css/master.css" media="all" />
  <meta class="swiftype" name="title" data-type="string" content="Add the Power of Webhooks to Your App with Okta's System Log | Okta Developer" />
  <meta class="swiftype" name="summary" data-type="string" content="If you’ve used webhooks before, you probably understand the magical powers they boast. Do you want to build a sleep tracker for your dog? Get notified when i..." />

  <link type="text/css" rel="stylesheet" href="/assets/animate-ec43d72c3ed45e08a460b8a2966d8dba6006aebfa0530935c3973fa493a8771f.css">
  <link type="text/css" rel="stylesheet" href="/assets/okta-bdc44e64f3ccf409e81fcbd180b78cdc72901f2b97af69c18e6bb44dd908d3d2.css">
  
  
  <title>Add the Power of Webhooks to Your App with Okta's System Log | Okta Developer</title>
  <meta name="description" content="If you’ve used webhooks before, you probably understand the magical powers they boast. Do you want to build a sleep tracker for your dog? Get notified when i...">
  <link rel="canonical" href="https://developer.okta.com/blog/2017/10/17/add-the-power-of-webhooks-to-your-app-with-oktas-system-log">
  <link rel="alternate" type="application/rss+xml" title="Okta Developer" href="https://developer.okta.com/feed.xml"><!-- GA -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#21313a">
  <meta name="theme-color" content="#ffffff">
</head>

  
    <body id="blog">
	




<header class="Header is-fixed">

  <div class="Wrap">

    <a class="Logo" href="https://developer.okta.com">
      <svg version="1.1" id="OktaLogo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 431.9 151.4" style="enable-background:new 0 0 431.9 151.4;" xml:space="preserve"><g><g><g><path d="M102.2,41.4c-21,0-38.1,17.1-38.1,38.1s17.1,38.1,38.1,38.1s38.1-17.1,38.1-38.1l0,0C140.3,58.5,123.2,41.4,102.2,41.4z M102.2,98.5c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19c0.1,10.5-8.4,19-18.9,19.1C102.3,98.6,102.2,98.6,102.2,98.5L102.2,98.5z"/><path d="M169.1,92.3c0-1.9,1.5-3.4,3.4-3.4c0.9,0,1.8,0.4,2.4,1c9.5,9.7,25.3,26.3,25.4,26.4c0.4,0.5,0.8,0.8,1.4,0.9l1.6,0.2h17.2c1.8,0,3.3-1.4,3.4-3.2c0-0.8-0.3-1.5-0.8-2.2l-28.6-29.2l-1.5-1.5c-3.2-3.9-2.9-5.4,0.8-9.3l22.6-25.1c1.1-1.4,0.8-3.5-0.6-4.6c-0.6-0.4-1.3-0.7-2-0.7h-17c-0.6,0.2-1.1,0.5-1.5,0.9L175,64.4c-1.3,1.4-3.4,1.5-4.8,0.2c-0.7-0.6-1.1-1.5-1.1-2.5V18.9c0-1.7-1.3-3-3-3c-0.1,0-0.2,0-0.3,0h-12.7c-2.2,0-3.3,1.5-3.3,2.8v95.8c0,2.2,1.8,2.8,3.3,2.8h12.7c1.7,0.1,3.2-1.2,3.3-2.9c0,0,0,0,0,0V92.3z"/><path d="M273,114l-1.4-12.8c-0.2-1.7-1.7-2.9-3.4-2.7c0,0,0,0-0.1,0l-2.9,0.2c-10.1,0-18.5-7.9-19-18c0-0.3,0-0.7,0-1V64.2c-0.1-2,1.5-3.6,3.5-3.7c0,0,0,0,0,0h17c1.7-0.1,3.1-1.5,3-3.2c0,0,0-0.1,0-0.1v-12c0-2.3-1.5-3.6-2.8-3.6h-17.1c-1.9,0.1-3.5-1.5-3.6-3.4c0,0,0,0,0,0V18.9c-0.1-1.7-1.5-3.1-3.2-3c0,0-0.1,0-0.1,0h-12.7c-1.6-0.1-3,1.1-3.1,2.7c0,0.1,0,0.1,0,0.2c0,0,0,61.7,0,62c0.5,21,17.9,37.6,38.9,37c1.4,0,2.9-0.2,4.3-0.3C272,117.2,273.2,115.7,273,114z"/></g><path d="M364.7,98c-10.8,0-12.4-3.8-12.4-18.3l0,0V44.8c0-1.8-1.4-3.2-3.2-3.2c0,0-0.1,0-0.1,0h-12.8c-1.8,0-3.2,1.4-3.3,3.2v1.6C314.6,36,291.3,42.5,281,60.8c-10.4,18.3-3.9,41.6,14.4,51.9c14,7.9,31.4,6.2,43.5-4.2c3.6,5.5,9.3,9.1,18.3,9.1c1.5,0,9.7,0.3,9.7-3.5v-13.6C367,99.2,366,98.1,364.7,98z M314.2,98.6c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19l0,0C333.2,90.1,324.7,98.6,314.2,98.6z"/></g><path d="M19.4,74c2.2-1.9,4.1-4.1,5.7-6.6c3.5-5.3,5.4-11.5,5.2-17.9V27c0-4.9,0.9-8.4,2.7-10.5c1.8-2.1,4.8-3,9.2-3h12.6c1.2,0,2.1-0.9,2.2-2.1l0,0V2.2C57,1,56,0,54.8,0c0,0,0,0,0,0H41.5c-7.8,0-12.9,2.1-18,7.6s-7.1,12.3-7.1,21.7v14.2c0,2.2-0.1,4-0.2,5.7v2.2c-0.5,3.2-1.8,6.2-3.6,8.9C9.4,64.7,5.1,70.9,0.9,74l0,0l-0.3,0.3l0,0l-0.2,0.3H0.2v0.3l0,0c-0.1,0.3-0.1,0.7,0,1l0,0v0.3h0.1l0.2,0.3l0,0l0.3,0.3l0,0c4.2,3.1,8.5,9.3,11.3,13.7c1.8,2.7,3.1,5.7,3.6,8.9v2.2c0.1,1.6,0.2,3.5,0.2,5.7v14.3c0,9.4,2.4,16.7,7.1,21.7s10.2,7.6,18,7.6h13.8c1.2,0,2.2-1,2.2-2.2V140l0,0c0-1.2-1-2.2-2.2-2.2H42.2c-4.4,0-7.5-1-9.2-3s-2.7-5.6-2.7-10.5v-22.4c0.2-6.4-1.7-12.6-5.2-17.9c-1.6-2.5-3.5-4.7-5.7-6.6l0,0c-0.9-0.7-1.1-2-0.4-2.9C19.2,74.3,19.3,74.2,19.4,74L19.4,74z"/><path d="M412.5,74c-2.2-1.9-4.1-4.1-5.7-6.6c-3.5-5.3-5.4-11.5-5.2-17.9V27c0-4.9-0.9-8.4-2.7-10.5s-4.8-3-9.2-3h-12.6c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0l0,0V2.2c0-1.2,1-2.2,2.2-2.2c0,0,0,0,0,0h13.4c7.8,0,12.9,2.1,18,7.6s7.1,12.3,7.1,21.7v14.2c0,2.2,0.1,4,0.2,5.7v2.2c0.5,3.2,1.8,6.2,3.6,8.9c2.8,4.5,7.1,10.7,11.3,13.7l0,0l0.3,0.3l0,0l0.2,0.3h0.1v0.3l0,0c0.1,0.3,0.1,0.7,0,1l0,0v0.3h-0.1l-0.2,0.3l0,0l-0.3,0.3l0,0c-4.2,3.1-8.5,9.3-11.3,13.7c-1.8,2.7-3.1,5.7-3.6,8.9v2.2c-0.1,1.6-0.2,3.5-0.2,5.7v14.3c0,9.4-2.4,16.7-7.1,21.7s-10.2,7.6-18,7.6h-13.4c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0V140l0,0c0-1.2,1-2.2,2.2-2.2l0,0h12.7c4.4,0,7.5-1,9.2-3s2.7-5.6,2.7-10.5v-22.4c-0.2-6.3,1.6-12.6,5.1-17.9c1.6-2.5,3.5-4.7,5.7-6.6l0,0c0.9-0.7,1.1-2,0.4-2.9C412.7,74.3,412.6,74.2,412.5,74L412.5,74z"/></g></svg>
    </a>

    <nav class="Header-nav PrimaryNav">
      <ul class="menu">
        <li class="first leaf">
          <a href="https://developer.okta.com/product/">Product</a>
        </li>
        <li class="leaf">
          <a href="https://developer.okta.com/pricing/">Pricing</a>
        </li>
        <li class="leaf">
          <a href="/blog/" class="active">Blog</a>
        </li>
        <li class="leaf">
          <a href="/documentation/">Docs</a>
        </li>
        <li class="last expanded">
          <span class="nolink">Support</span>
          <ul class="menu">
            <li class="first leaf"><a href="https://devforum.okta.com/">Okta Developer Forums</a></li>
            <li class="last leaf"><a href="mailto:developers@okta.com">developers@okta.com</a></li>
          </ul>
        </li>
      </ul>
      <a class="PrimaryNav-toggle" href="#">
        <svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g class="MenuIcon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round">
                <path d="M1,16 L19,16" class="MenuIcon-line1" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,4 L19,4" class="MenuIcon-line2" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line3" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line4" stroke="#FFFFFF" stroke-width="2"></path>
            </g>
        </svg>
        <svg class="CloseIcon" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <g id="ALl-Boards" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="Desktop" transform="translate(-915.000000, -235.000000)" fill="#FFFFFF">
              <g id="Search-bar-Active" transform="translate(30.000000, 26.000000)">
                <polygon id="Icon/Cross" points="901 210.6 899.4 209 893 215.4 886.6 209 885 210.6 891.4 217 885 223.4 886.6 225 893 218.6 899.4 225 901 223.4 894.6 217"></polygon>
              </g>
            </g>
          </g>
        </svg>
      </a>

      <div class="PrimaryNav-cta">
        <a target="_blank" rel="noopener noreferrer" href="https://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3Dhttps://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3D" class="Button--redOutline">Login</a>
        <a href="https://developer.okta.com/signup/" class="Button--red">Sign up</a>
      </div>

      <a class="SearchIcon" href="#"></a>
      <form id="form_search" class="SearchBar Formisimo_clocked_69929" method="get" action="https://developer.okta.com/search/" name="form_search" __bizdiag="-784164280" __biza="WJ__">
        <input type="text" name="stq" autocomplete="off" id="st-search-input-auto" class="st-search-input" placeholder="Search">
        <input type="submit" name="submit" value="GO">
      </form>

    </nav>

  </div>

</header>

	<div class="page-content">
		






<section class="Blog is-single">
		
	<div class="Blog-social">
		
		<a href="https://github.com/jpf" target="_blank"><i class="fa fa-github"></i></a>
		
		
		<a href="https://twitter.com/jf" target="_blank"><i class="fa fa-twitter"></i></a>
		
		
		
		<a href="http://joel.franusic.com" target="_blank"><i class="fa fa-external-link"></i></a>
		
	</div>
	
	

<article class="BlogPost">
	
	<header class="BlogPost-header">
	
		<time class="BlogPost-date" datetime="2017-10-17">October 17, 2017</time>
		
		<h1 class="BlogPost-title">
			
			Add the Power of Webhooks to Your App with Okta's System Log
			
		</h1>
		
		<div class="BlogPost-attribution">
			
				<img src="/assets/avatar-jf-43c520fa0952cfa58baa9e516e02339fd926109338f978d821c3bf6ee6bf1673.jpg" alt="avatar-jf.jpg" class="BlogPost-avatar">
			
			<span class="BlogPost-author">Joël Franusic</span>
		</div>
	
	</header>
	
	<div class="BlogPost-content">
		
	<p>If you’ve used webhooks before, you probably understand the magical powers they boast. Do you want to build a sleep tracker for your dog? Get notified when it’s going to rain? Or maybe have new Eventbrite attendees automatically added to Salesforce? You can do all of those things with webhooks and services like Twilio, Zapier and Workato.</p>

<p>To get webhooks with Okta, this post will show you how to use an underappreciated features in Okta, the System Log. It’s a record of all activity that happens in your Okta org. Examples of the events that get recorded in your System Log are:</p>

<ul>
  <li>Failed login attempts</li>
  <li>When a user is added or removed from a group</li>
  <li>When a user is promoted to an administrator</li>
</ul>

<p>In this post, I will be showing you how to use the Go programming language to write a command line utility that will poll the Okta System Log for pre-configured events that match a regular expression, then fire that event data off via a webhook.</p>

<p>If you’re impatient and want to try out the finished software and start sending webhooks from Okta, you can download the “loghook” program below and get started:</p>

<ul>
  <li><a href="https://github.com/jpf/loghook/releases/download/v0.0.4/loghook_darwin_amd64.zip">macOS</a></li>
  <li><a href="https://github.com/jpf/loghook/releases/download/v0.0.4/loghook_linux_amd64.zip">Linux</a></li>
</ul>

<p>Let’s discuss what webhooks are. Simply stated, they are “<a href="http://timothyfitz.com/2009/02/09/what-webhooks-are-and-why-you-should-care/">user-defined HTTP callbacks</a>”. In concrete terms what this means is that by implementing webhooks with Okta, you can integrate Okta into any website that supports callbacks via webhooks.</p>

<p>One of the major benefits of using webhooks is that they are so composable. Any developer who is familiar with the semantics of HTTP can use webhooks to integrate Okta with any system they can interact with
via a web application. And, because of the widespread adoption of webhooks, you can integrate directly into services like Loggly and Zapier without needing to implement anything beyond basic HTTP handlers.</p>

<h2 id="use-go-to-turn-system-log-events-into-webhooks">Use Go to Turn System Log Events into Webhooks</h2>

<p>Below, we will cover the critical parts of the “loghook” command that takes System Log events from Okta and turns them into webhooks.</p>

<p>The key parts of this code are as follows:</p>

<ul>
  <li>The main event loop</li>
  <li>Getting System Log events from Okta</li>
  <li>Processing events</li>
  <li>Sending webhooks</li>
</ul>

<p>As you walk through the webhook implementation, I encourage you to keep the source code open to get a sense of where we are:</p>

<p><a href="https://github.com/jpf/loghook">https://github.com/jpf/loghook</a></p>

<h2 id="set-up-the-main-event-loop">Set Up the Main Event Loop</h2>

<p>Let’s start by looking at the main loop that drives the core of this program:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">logEvent</span><span class="p">,</span><span class="x"> </span><span class="n">raw</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">logEvent</span><span class="o">.</span><span class="n">Published</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Since</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">logEvent</span><span class="o">.</span><span class="n">Published</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="x"> </span><span class="o">*</span><span class="x"> </span><span class="m">1</span><span class="p">)</span><span class="x">
        </span><span class="p">}</span><span class="x">
        </span><span class="n">eventProcessor</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">logEvent</span><span class="p">,</span><span class="x"> </span><span class="n">raw</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">logEvents</span><span class="o">.</span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Warning</span><span class="p">(</span><span class="s">"Error:"</span><span class="p">,</span><span class="x"> </span><span class="n">logEvents</span><span class="o">.</span><span class="n">err</span><span class="p">)</span><span class="x">
        </span><span class="k">break</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Sleep</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>What you see above are two nested <code class="highlighter-rouge">for</code> loops.</p>

<p>The innermost <code class="highlighter-rouge">for</code> loop uses a <a href="https://ewencp.org/blog/golang-iterators/#pattern-4-stateful-iterators">stateful iterator</a> to iterate over any events that might be in the System Log. For each event, we’ll call the <code class="highlighter-rouge">Process()</code> method to process the event. Also, if the event has a “Published” time, use that time as the “last seen” or time “Since” we last saw an event. Note that we add “1” second to this time to avoid duplicates, which might lead to missed events for high volume Okta orgs.</p>

<p>The outermost <code class="highlighter-rouge">for</code> loop allows us to check for errors fetching events and then sleep after we’ve processed a batch of events.</p>

<p>Now that you’ve got an idea of how the main loop works let’s take a look at the whole function that runs the main loop. This code below contains the main loop, but also has the code we use to configure the Okta log client as well as the event processing code which loads configuration from a file named <code class="highlighter-rouge">loghook.csv</code>:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">SetOutput</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">)</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">SetLevel</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">InfoLevel</span><span class="p">)</span><span class="x">

    </span><span class="n">oktaLogClient</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">logClient</span><span class="p">{</span><span class="x">
        </span><span class="n">oktaOrgUrl</span><span class="o">:</span><span class="x">   </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"OKTA_ORG_URL"</span><span class="p">),</span><span class="x">
        </span><span class="n">apiToken</span><span class="o">:</span><span class="x">     </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"OKTA_API_KEY"</span><span class="p">),</span><span class="x">
        </span><span class="n">retrySeconds</span><span class="o">:</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Getenv</span><span class="p">(</span><span class="s">"LOGHOOK_RETRY_SECONDS"</span><span class="p">),</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">logEvents</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">oktaLogClient</span><span class="o">.</span><span class="n">Tail</span><span class="p">()</span><span class="x">
    </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Since</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Minute</span><span class="x"> </span><span class="o">*</span><span class="x"> </span><span class="o">-</span><span class="m">2</span><span class="p">)</span><span class="x">

    </span><span class="n">eventProcessor</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">eventProcessorInit</span><span class="p">()</span><span class="x">
    </span><span class="n">eventProcessor</span><span class="o">.</span><span class="n">LoadConfig</span><span class="p">(</span><span class="s">"loghook.csv"</span><span class="p">)</span><span class="x">

    </span><span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Started polling for events at: "</span><span class="p">,</span><span class="x"> </span><span class="n">oktaLogClient</span><span class="o">.</span><span class="n">oktaOrgUrl</span><span class="p">)</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="k">for</span><span class="x"> </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Next</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">logEvent</span><span class="p">,</span><span class="x"> </span><span class="n">raw</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Get</span><span class="p">()</span><span class="x">
            </span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">logEvent</span><span class="o">.</span><span class="n">Published</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
                </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Since</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">logEvent</span><span class="o">.</span><span class="n">Published</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="x"> </span><span class="o">*</span><span class="x"> </span><span class="m">1</span><span class="p">)</span><span class="x">
            </span><span class="p">}</span><span class="x">
            </span><span class="n">eventProcessor</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">logEvent</span><span class="p">,</span><span class="x"> </span><span class="n">raw</span><span class="p">)</span><span class="x">
        </span><span class="p">}</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">logEvents</span><span class="o">.</span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">log</span><span class="o">.</span><span class="n">Warning</span><span class="p">(</span><span class="s">"Error:"</span><span class="p">,</span><span class="x"> </span><span class="n">logEvents</span><span class="o">.</span><span class="n">err</span><span class="p">)</span><span class="x">
            </span><span class="k">break</span><span class="x">
        </span><span class="p">}</span><span class="x">
        </span><span class="n">logEvents</span><span class="o">.</span><span class="n">Sleep</span><span class="p">()</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>Note in particular the use of <code class="highlighter-rouge">os.Getenv</code> which we use to get Okta configuration from environment variables.</p>

<h3 id="a-note-about-logging">A Note About Logging</h3>

<p>As you read through this code, you’ll notice a lot of usage of <code class="highlighter-rouge">log</code>. If you aren’t familiar with it yet, this is the <a href="https://golang.org/pkg/log/">log</a> package that is part of the Go standard library.</p>

<p>In this project, we configure <code class="highlighter-rouge">log</code> to send log output to the <a href="https://www.gnu.org/software/libc/manual/html_node/Standard-Streams.html">Standard Out</a> stream and to only display messages marked as the “Information” <a href="https://tools.ietf.org/html/rfc5424#page-11">severity level</a> or higher:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="n">log</span><span class="o">.</span><span class="n">SetOutput</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="p">)</span><span class="x">
</span><span class="n">log</span><span class="o">.</span><span class="n">SetLevel</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">InfoLevel</span><span class="p">)</span><span class="x">
</span></code></pre>
</div>

<h2 id="get-system-log-events-from-okta">Get System Log Events From Okta</h2>

<p>In this section, I’ll cover how we use the <code class="highlighter-rouge">Next()</code>, <code class="highlighter-rouge">Get()</code>, and <code class="highlighter-rouge">Sleep()</code> functions to abstract away some of the complexity in fetching System Log events from Okta.</p>

<p>At a high level, here is what each of these functions does:</p>

<ol>
  <li><code class="highlighter-rouge">Tail()</code>: creates a stateful iterator for the System Log</li>
  <li><code class="highlighter-rouge">Next()</code>: returns a boolean “true” if there is another System Log event to fetch or returns boolean “false” otherwise. This function also transparently handles paginated results from the System Log.</li>
  <li><code class="highlighter-rouge">Get()</code>: fetches the next event in the System Log</li>
  <li><code class="highlighter-rouge">Sleep()</code>: sleeps for 15 seconds by defaults, or the interval configured using an environment variable</li>
</ol>

<p>Let’s take a look at each of these functions in detail:</p>

<h3 id="tail">Tail()</h3>

<p>The code below is syntactic sugar used to initialize a stateful iterator for the System Log.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">c</span><span class="x"> </span><span class="o">*</span><span class="n">logClient</span><span class="p">)</span><span class="x"> </span><span class="n">Tail</span><span class="p">()</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">logEventResult</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">logEvent</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">logEventResult</span><span class="p">{</span><span class="x">
        </span><span class="n">logClient</span><span class="o">:</span><span class="x"> </span><span class="n">c</span><span class="p">,</span><span class="x">
        </span><span class="n">offset</span><span class="o">:</span><span class="x">    </span><span class="o">-</span><span class="m">1</span><span class="p">,</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">logEvent</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h3 id="next">Next()</h3>

<p>The <code class="highlighter-rouge">Next()</code> function uses an “offset” to keep track of where you are in the results from Okta. It uses the following logic:</p>

<ul>
  <li>If the offset is undefined (<code class="highlighter-rouge">-1</code>), then fetch results from Okta</li>
  <li>If the offset is less than the results from Okta then return boolean “true” because you have results left</li>
  <li>Otherwise, we’ve run out of results, so check to see if the results were paginated and then fetch the next set of results if so</li>
  <li>Finally, if you have no more results and no more pages to list, reset and return boolean “false” as you have no more results to return</li>
</ul>

<p>Here is the code that implements this logic:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">l</span><span class="x"> </span><span class="o">*</span><span class="n">logEventResult</span><span class="p">)</span><span class="x"> </span><span class="n">Next</span><span class="p">()</span><span class="x"> </span><span class="kt">bool</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">offset</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="o">-</span><span class="m">1</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">getEvents</span><span class="p">(</span><span class="s">""</span><span class="p">)</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">log</span><span class="o">.</span><span class="n">Warning</span><span class="p">(</span><span class="s">"Error:"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
            </span><span class="k">return</span><span class="x"> </span><span class="no">false</span><span class="x">
        </span><span class="p">}</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">offset</span><span class="x"> </span><span class="o">&lt;</span><span class="x"> </span><span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">events</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="k">return</span><span class="x"> </span><span class="no">true</span><span class="x">
    </span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="k">if</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">nextLink</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="s">""</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">getEvents</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">nextLink</span><span class="p">)</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">log</span><span class="o">.</span><span class="n">Warning</span><span class="p">(</span><span class="s">"Error: "</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
            </span><span class="k">return</span><span class="x"> </span><span class="no">false</span><span class="x">
        </span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="k">return</span><span class="x"> </span><span class="no">true</span><span class="x">
        </span><span class="p">}</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="c">// Try again next time</span><span class="x">
    </span><span class="n">l</span><span class="o">.</span><span class="n">offset</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="o">-</span><span class="m">1</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="no">false</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>Astute readers will note that the <code class="highlighter-rouge">Next()</code> function makes several calls to the private <code class="highlighter-rouge">getEvents()</code> function. Let’s take a look at that function. Here’s what the <code class="highlighter-rouge">getEvents()</code> function does:</p>

<ol>
  <li>
    <p>Construct the request URL, using query parameters if needed.</p>

    <div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="n">log</span><span class="o">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">"Events since: "</span><span class="p">,</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">Since</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">loc</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="s">""</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">u</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">url</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">logClient</span><span class="o">.</span><span class="n">oktaOrgUrl</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"/api/v1/logs"</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">l</span><span class="o">.</span><span class="n">Since</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">q</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">u</span><span class="o">.</span><span class="n">Query</span><span class="p">()</span><span class="x">
        </span><span class="n">q</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"since"</span><span class="p">,</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">Since</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">))</span><span class="x">
        </span><span class="n">q</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"until"</span><span class="p">,</span><span class="x"> </span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">))</span><span class="x">
        </span><span class="n">u</span><span class="o">.</span><span class="n">RawQuery</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">q</span><span class="o">.</span><span class="n">Encode</span><span class="p">()</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">loc</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">u</span><span class="o">.</span><span class="n">String</span><span class="p">()</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="n">log</span><span class="o">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">"Getting URL: "</span><span class="p">,</span><span class="x"> </span><span class="n">loc</span><span class="p">)</span><span class="x">
</span><span class="n">req</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span><span class="x"> </span><span class="n">loc</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
    </div>
  </li>
  <li>
    <p>Set the appropriate headers for our HTTP request to Okta.</p>

    <div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Accept"</span><span class="p">,</span><span class="x"> </span><span class="s">"application/json"</span><span class="p">)</span><span class="x">
</span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span><span class="x"> </span><span class="s">"SSWS "</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">logClient</span><span class="o">.</span><span class="n">apiToken</span><span class="p">)</span><span class="x">
</span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Cache-Control"</span><span class="p">,</span><span class="x"> </span><span class="s">"no-cache"</span><span class="p">)</span><span class="x">
</span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span><span class="x"> </span><span class="s">"application/json"</span><span class="p">)</span><span class="x">
</span></code></pre>
    </div>
  </li>
  <li>
    <p>Execute the HTTP request, checking for errors.</p>

    <div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="n">resp</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">DefaultClient</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="k">defer</span><span class="x"> </span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
</span></code></pre>
    </div>
  </li>
  <li>
    <p>Determine if the response was paginated by checking for a <code class="highlighter-rouge">Link</code> header in the HTTP response</p>

    <div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">value</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">resp</span><span class="o">.</span><span class="n">Header</span><span class="p">[</span><span class="s">"Link"</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">match</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">rfc5988</span><span class="o">.</span><span class="n">FindStringSubmatch</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="x">
    </span><span class="n">link</span><span class="p">,</span><span class="x"> </span><span class="n">rel</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">match</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="x"> </span><span class="n">match</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">rel</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="s">"next"</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">l</span><span class="o">.</span><span class="n">nextLink</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">link</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
    </div>
  </li>
  <li>
    <p>Finally, decode the response into an array of raw JSON strings</p>

    <div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="n">l</span><span class="o">.</span><span class="n">offset</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">0</span><span class="x">
</span><span class="n">l</span><span class="o">.</span><span class="n">events</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">make</span><span class="p">([]</span><span class="n">json</span><span class="o">.</span><span class="n">RawMessage</span><span class="p">,</span><span class="x"> </span><span class="m">100</span><span class="p">)</span><span class="x">
</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">.</span><span class="n">events</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span></code></pre>
    </div>
  </li>
</ol>

<p>This section of code is short, but is the most important and interesting part of this project. By defining <code class="highlighter-rouge">l.events</code> as a slice of <code class="highlighter-rouge">json.RawMessage</code> types, this code does not need to know anything about the structure of events from the Okta System Log. Thus, you don’t need to have a fully defined <a href="https://tour.golang.org/moretypes/2">struct</a> for System Log events, all you need to do is to parse out what is important to you (in this case, the <code class="highlighter-rouge">eventType</code>) and then POST the full string as a webhook when you find an event you want to pass on. Without using <code class="highlighter-rouge">json.RawMessage</code>, you’d have to account for every possible System Log event type or risk losing data when you serialize a Go object back into a JSON string.</p>

<p>Here’s what it all looks like when it’s put together into one function:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">l</span><span class="x"> </span><span class="o">*</span><span class="n">logEventResult</span><span class="p">)</span><span class="x"> </span><span class="n">getEvents</span><span class="p">(</span><span class="n">loc</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">"Events since: "</span><span class="p">,</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">Since</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">loc</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="s">""</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">u</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">url</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">logClient</span><span class="o">.</span><span class="n">oktaOrgUrl</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="s">"/api/v1/logs"</span><span class="p">)</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
        </span><span class="p">}</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">l</span><span class="o">.</span><span class="n">Since</span><span class="o">.</span><span class="n">IsZero</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">q</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">u</span><span class="o">.</span><span class="n">Query</span><span class="p">()</span><span class="x">
            </span><span class="n">q</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"since"</span><span class="p">,</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">Since</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">))</span><span class="x">
            </span><span class="n">q</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"until"</span><span class="p">,</span><span class="x"> </span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">UTC</span><span class="p">()</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">))</span><span class="x">
            </span><span class="n">u</span><span class="o">.</span><span class="n">RawQuery</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">q</span><span class="o">.</span><span class="n">Encode</span><span class="p">()</span><span class="x">
        </span><span class="p">}</span><span class="x">
        </span><span class="n">loc</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">u</span><span class="o">.</span><span class="n">String</span><span class="p">()</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">"Getting URL: "</span><span class="p">,</span><span class="x"> </span><span class="n">loc</span><span class="p">)</span><span class="x">
    </span><span class="n">req</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span><span class="x"> </span><span class="n">loc</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="k">return</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">

    </span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Accept"</span><span class="p">,</span><span class="x"> </span><span class="s">"application/json"</span><span class="p">)</span><span class="x">
    </span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span><span class="x"> </span><span class="s">"SSWS "</span><span class="o">+</span><span class="n">l</span><span class="o">.</span><span class="n">logClient</span><span class="o">.</span><span class="n">apiToken</span><span class="p">)</span><span class="x">
    </span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Cache-Control"</span><span class="p">,</span><span class="x"> </span><span class="s">"no-cache"</span><span class="p">)</span><span class="x">
    </span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span><span class="x"> </span><span class="s">"application/json"</span><span class="p">)</span><span class="x">

    </span><span class="n">resp</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">DefaultClient</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="k">return</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">defer</span><span class="x"> </span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">

    </span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">value</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">resp</span><span class="o">.</span><span class="n">Header</span><span class="p">[</span><span class="s">"Link"</span><span class="p">]</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">match</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">rfc5988</span><span class="o">.</span><span class="n">FindStringSubmatch</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="x">
        </span><span class="n">link</span><span class="p">,</span><span class="x"> </span><span class="n">rel</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">match</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="x"> </span><span class="n">match</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">rel</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="s">"next"</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">l</span><span class="o">.</span><span class="n">nextLink</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">link</span><span class="x">
        </span><span class="p">}</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">l</span><span class="o">.</span><span class="n">offset</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">0</span><span class="x">
    </span><span class="n">l</span><span class="o">.</span><span class="n">events</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">make</span><span class="p">([]</span><span class="n">json</span><span class="o">.</span><span class="n">RawMessage</span><span class="p">,</span><span class="x"> </span><span class="m">100</span><span class="p">)</span><span class="x">
    </span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">NewDecoder</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="p">)</span><span class="o">.</span><span class="n">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">l</span><span class="o">.</span><span class="n">events</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="k">return</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h3 id="get">Get()</h3>

<p>Gets the current System Log event from the internal <code class="highlighter-rouge">events</code> property, using the <code class="highlighter-rouge">offset</code> property to keep track of which property is the current one.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">l</span><span class="x"> </span><span class="o">*</span><span class="n">logEventResult</span><span class="p">)</span><span class="x"> </span><span class="n">Get</span><span class="p">()</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">oktaLogEvent</span><span class="p">,</span><span class="x"> </span><span class="o">*</span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">raw</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">offset</span><span class="p">])</span><span class="x">
    </span><span class="n">l</span><span class="o">.</span><span class="n">offset</span><span class="x"> </span><span class="o">+=</span><span class="x"> </span><span class="m">1</span><span class="x">

    </span><span class="k">var</span><span class="x"> </span><span class="n">oktaEvent</span><span class="x"> </span><span class="n">oktaLogEvent</span><span class="x">
    </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">raw</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">oktaEvent</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">l</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
        </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="no">nil</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="o">&amp;</span><span class="n">oktaEvent</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">raw</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h3 id="sleep">Sleep()</h3>

<p>This code is used to wait between calls to the System Log. Uses the value in the <code class="highlighter-rouge">LOGHOOK_RETRY_SECONDS</code> environment variable as the number of seconds to wait, or 15 seconds otherwise.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">l</span><span class="x"> </span><span class="o">*</span><span class="n">logEventResult</span><span class="p">)</span><span class="x"> </span><span class="n">Sleep</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">ts</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">l</span><span class="o">.</span><span class="n">Since</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">)</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">WithFields</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">Fields</span><span class="p">{</span><span class="s">"last_seen"</span><span class="o">:</span><span class="x"> </span><span class="n">ts</span><span class="p">})</span><span class="o">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">"Sleeping"</span><span class="p">)</span><span class="x">
    </span><span class="k">var</span><span class="x"> </span><span class="n">retrySeconds</span><span class="x"> </span><span class="kt">int</span><span class="x">
    </span><span class="n">retrySeconds</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">strconv</span><span class="o">.</span><span class="n">Atoi</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">logClient</span><span class="o">.</span><span class="n">retrySeconds</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">retrySeconds</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="m">15</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="x"> </span><span class="o">*</span><span class="x"> </span><span class="n">time</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="n">retrySeconds</span><span class="p">))</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h2 id="process-events">Process Events</h2>

<p>Now that we’ve covered how we get events from Okta’s System Log, let’s go over how to process these events and decide which events to send as webhooks and where to send those events.</p>

<p>Let’s start with <code class="highlighter-rouge">loghook.csv</code>, the configuration file that our <code class="highlighter-rouge">loghook</code> command will use to decide which events to send and to where.</p>

<p>Here is what an example <code class="highlighter-rouge">loghook.csv</code> would look like:</p>

<pre><code class="language-csv">^example.example,http://example.com
</code></pre>

<p>This file is a <a href="https://tools.ietf.org/html/rfc4180">CSV</a> file, meaning that we use commas to separate values. Each line in this file has two values:</p>

<ol>
  <li>A regular expression for matching an <code class="highlighter-rouge">eventType</code> for an event</li>
  <li>The URL where the JSON payload for the event will be sent via an HTTP POST</li>
</ol>

<p>In the example above, any event in the Okta System Log that has the type of <code class="highlighter-rouge">example.example</code> will be sent to the URL <code class="highlighter-rouge">http://example.com</code>. Note that no Okta events will have the type of <code class="highlighter-rouge">example.example</code>, so this line is safe to keep in your configuration file.</p>

<p>Here are the steps you’ll use to load the configuration into this program:</p>

<ol>
  <li>Load the configuration from the <code class="highlighter-rouge">loghook.csv</code> file.</li>
  <li>Turn each <a href="https://golang.org/pkg/regexp/#Regexp">regular expression</a> and <a href="https://golang.org/pkg/net/url/">URL</a> into their respective types in Go and store the results in an array.</li>
</ol>

<p>Loading the <code class="highlighter-rouge">loghook.csv</code> file is easy, we just use Go’s <a href="https://golang.org/pkg/encoding/csv/">built-in CSV parsing package</a>:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">p</span><span class="x"> </span><span class="o">*</span><span class="n">eventProcessor</span><span class="p">)</span><span class="x"> </span><span class="n">LoadConfig</span><span class="p">(</span><span class="n">filename</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">f</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">defer</span><span class="x"> </span><span class="n">f</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
    </span><span class="n">records</span><span class="p">,</span><span class="x"> </span><span class="n">_</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">csv</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">ReadAll</span><span class="p">()</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">record</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">records</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">p</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="m">0</span><span class="p">],</span><span class="x"> </span><span class="n">record</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>For each line in the CSV file, we call the <code class="highlighter-rouge">Add()</code> method to process the regular expression and URL in the line, then append an array containing the compiled regular expression and URL to our list of “processors”:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">p</span><span class="x"> </span><span class="o">*</span><span class="n">eventProcessor</span><span class="p">)</span><span class="x"> </span><span class="n">Add</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span><span class="x"> </span><span class="n">destination</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">re</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">regexp</span><span class="o">.</span><span class="n">Compile</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Error compiling Regular Expression: "</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">url</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">url</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"Error parsing destination URL: "</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">p</span><span class="o">.</span><span class="n">Handlers</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">Handlers</span><span class="p">,</span><span class="x"> </span><span class="n">eventHandler</span><span class="p">{</span><span class="n">re</span><span class="p">,</span><span class="x"> </span><span class="n">url</span><span class="p">})</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"Sending events matching '%s' to '%s'"</span><span class="p">,</span><span class="x"> </span><span class="n">expression</span><span class="p">,</span><span class="x"> </span><span class="n">destination</span><span class="p">))</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>Here are how we define the <code class="highlighter-rouge">eventProcessor</code> type and the <code class="highlighter-rouge">Handler</code> Array in the <code class="highlighter-rouge">eventProcessor</code>:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">type</span><span class="x"> </span><span class="n">eventHandler</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">Expression</span><span class="x"> </span><span class="o">*</span><span class="n">regexp</span><span class="o">.</span><span class="n">Regexp</span><span class="x">
    </span><span class="n">URL</span><span class="x">        </span><span class="o">*</span><span class="n">url</span><span class="o">.</span><span class="n">URL</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">eventProcessor</span><span class="x"> </span><span class="k">struct</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">Handlers</span><span class="x"> </span><span class="p">[]</span><span class="n">eventHandler</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="n">eventProcessorInit</span><span class="p">()</span><span class="x"> </span><span class="n">eventProcessor</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">processor</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">eventProcessor</span><span class="p">{}</span><span class="x">
    </span><span class="n">processor</span><span class="o">.</span><span class="n">Handlers</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="p">[]</span><span class="n">eventHandler</span><span class="p">{}</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">processor</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<p>Finally, here is one of the core functions in this program, the function that processes each event and determines if the event should be sent via a webhook.</p>

<p>This function works by iterating over each handler. If the <code class="highlighter-rouge">eventType</code> of that event matches the regular expression for a handler, then a webhook is sent to the URL that corresponds to that
regular expression:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">p</span><span class="x"> </span><span class="o">*</span><span class="n">eventProcessor</span><span class="p">)</span><span class="x"> </span><span class="n">Process</span><span class="p">(</span><span class="n">event</span><span class="x"> </span><span class="o">*</span><span class="n">oktaLogEvent</span><span class="p">,</span><span class="x"> </span><span class="n">raw</span><span class="x"> </span><span class="o">*</span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">handler</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">p</span><span class="o">.</span><span class="n">Handlers</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">re</span><span class="p">,</span><span class="x"> </span><span class="n">url</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">handler</span><span class="o">.</span><span class="n">Expression</span><span class="p">,</span><span class="x"> </span><span class="n">handler</span><span class="o">.</span><span class="n">URL</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">WithFields</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">Fields</span><span class="p">{</span><span class="x">
            </span><span class="s">"UUID"</span><span class="o">:</span><span class="x">      </span><span class="n">event</span><span class="o">.</span><span class="n">UUID</span><span class="p">,</span><span class="x">
            </span><span class="s">"Published"</span><span class="o">:</span><span class="x"> </span><span class="n">event</span><span class="o">.</span><span class="n">Published</span><span class="o">.</span><span class="n">Format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">RFC3339</span><span class="p">),</span><span class="x">
            </span><span class="s">"EventType"</span><span class="o">:</span><span class="x"> </span><span class="n">event</span><span class="o">.</span><span class="n">EventType</span><span class="p">,</span><span class="x">
        </span><span class="p">})</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Event"</span><span class="p">)</span><span class="x">
        </span><span class="k">if</span><span class="x"> </span><span class="n">re</span><span class="o">.</span><span class="n">MatchString</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">EventType</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
            </span><span class="n">sendWebhook</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="x"> </span><span class="n">event</span><span class="p">,</span><span class="x"> </span><span class="n">raw</span><span class="p">)</span><span class="x">
        </span><span class="p">}</span><span class="x">
    </span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
</div>

<h2 id="send-your-webhooks">Send Your Webhooks</h2>

<p>Last is <code class="highlighter-rouge">sendWebhook</code>, the function that makes the HTTP request (or webhook) to a URL. This code is a pretty standard HTTP client, we set up a POST request, configure a few headers, then make the request.</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">sendWebhook</span><span class="p">(</span><span class="n">url</span><span class="x"> </span><span class="o">*</span><span class="n">url</span><span class="o">.</span><span class="n">URL</span><span class="p">,</span><span class="x"> </span><span class="n">event</span><span class="x"> </span><span class="o">*</span><span class="n">oktaLogEvent</span><span class="p">,</span><span class="x"> </span><span class="n">payload</span><span class="x"> </span><span class="o">*</span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">Debug</span><span class="p">(</span><span class="s">"POSTing to URL:"</span><span class="p">,</span><span class="x"> </span><span class="n">url</span><span class="p">)</span><span class="x">

    </span><span class="n">req</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">http</span><span class="o">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"POST"</span><span class="p">,</span><span class="x"> </span><span class="n">url</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span><span class="x"> </span><span class="n">bytes</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="o">*</span><span class="n">payload</span><span class="p">))</span><span class="x">
    </span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"User-Agent"</span><span class="p">,</span><span class="x"> </span><span class="n">userAgent</span><span class="p">)</span><span class="x">
    </span><span class="n">req</span><span class="o">.</span><span class="n">Header</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span><span class="x"> </span><span class="s">"application/json"</span><span class="p">)</span><span class="x">

    </span><span class="n">client</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">http</span><span class="o">.</span><span class="n">Client</span><span class="p">{}</span><span class="x">
    </span><span class="n">resp</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">client</span><span class="o">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">log</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="k">defer</span><span class="x"> </span><span class="n">resp</span><span class="o">.</span><span class="n">Body</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">

    </span><span class="n">log</span><span class="o">.</span><span class="n">WithFields</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">Fields</span><span class="p">{</span><span class="s">"EventType"</span><span class="o">:</span><span class="x"> </span><span class="n">event</span><span class="o">.</span><span class="n">EventType</span><span class="p">,</span><span class="x"> </span><span class="s">"URL"</span><span class="o">:</span><span class="x"> </span><span class="n">url</span><span class="p">})</span><span class="o">.</span><span class="n">Info</span><span class="p">(</span><span class="s">"Match found"</span><span class="p">)</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">

</span></code></pre>
</div>

<p>The only thing that isn’t obvious above is where the <code class="highlighter-rouge">userAgent</code> string is defined. This string is configured once at runtime and will look something like this: <code class="highlighter-rouge">loghook/0.0.2 go/1.8.3 darwin/16.7.0</code></p>

<p>Here is how the <code class="highlighter-rouge">userAgent</code> string is defined:</p>

<div class="language-go highlighter-rouge"><pre class="highlight"><code><span class="k">func</span><span class="x"> </span><span class="n">makeUserAgent</span><span class="p">()</span><span class="x"> </span><span class="kt">string</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">goVersion</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">strings</span><span class="o">.</span><span class="n">Replace</span><span class="p">(</span><span class="n">runtime</span><span class="o">.</span><span class="n">Version</span><span class="p">(),</span><span class="x"> </span><span class="s">"go"</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="o">-</span><span class="m">1</span><span class="p">)</span><span class="x">
    </span><span class="n">osVersion</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">osversion</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span><span class="x">
    </span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
        </span><span class="n">osVersion</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="s">"ERROR"</span><span class="x">
    </span><span class="p">}</span><span class="x">
    </span><span class="n">userAgent</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s/%s go/%s %s/%s"</span><span class="p">,</span><span class="x">
        </span><span class="s">"loghook"</span><span class="p">,</span><span class="x"> </span><span class="c">// clientName</span><span class="x">
        </span><span class="s">"0.0.3"</span><span class="p">,</span><span class="x">   </span><span class="c">// Version</span><span class="x">
        </span><span class="n">goVersion</span><span class="p">,</span><span class="x">
        </span><span class="n">runtime</span><span class="o">.</span><span class="n">GOOS</span><span class="p">,</span><span class="x">
        </span><span class="n">osVersion</span><span class="p">,</span><span class="x">
    </span><span class="p">)</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">userAgent</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">var</span><span class="x"> </span><span class="n">userAgent</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">makeUserAgent</span><span class="p">()</span><span class="x">
</span></code></pre>
</div>

<h2 id="running-loghook-yourself">Running Loghook Yourself</h2>

<p>You’re all done reading the code now! If you want to see loghook in action with your own Okta org, just follow the steps below.</p>

<p>Get loghook on your system by downloading a pre-compiled binary above or compiling it yourself as follows:</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">git</span><span class="kv"> clone https://github.com/jpf/loghook.git
</span><span class="w">$ </span><span class="nc">cd</span><span class="kv"> loghook
</span><span class="w">$ </span><span class="nc">go</span><span class="kv"> get github.com/getlantern/osversion
</span><span class="w">$ </span><span class="nc">go</span><span class="kv"> get github.com/sirupsen/logrus
</span><span class="w">$ </span><span class="nc">go</span><span class="kv"> build loghook.go
</span></code></pre>
</div>

<p>At this point, you will have a binary named <code class="highlighter-rouge">loghook</code> in your current directory. Now you’ll need to configure the environment variables that <code class="highlighter-rouge">loghook</code> uses and then edit the <code class="highlighter-rouge">loghook.csv</code> file:</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">export</span><span class="kv"> OKTA_ORG_URL="https://{yourOktaDomain}.com"
</span><span class="w">$ </span><span class="nc">export</span><span class="kv"> OKTA_API_KEY="01A_BcDE23fgH4IJKLM5nop_QRstUvwXYZ6aBC78dE"
</span></code></pre>
</div>

<p><strong>IMPORTANT</strong>: The values for <code class="highlighter-rouge">OKTA_ORG_URL</code> and <code class="highlighter-rouge">OKTA_API_KEY</code> above are examples. You will need to use the URL for your own Okta org as well as <a href="https://developer.okta.com/docs/api/getting_started/getting_a_token.html">create an API token</a> to allow <code class="highlighter-rouge">loghook</code> to connect to your Okta org.</p>

<p>Now, you’ll need to edit the <code class="highlighter-rouge">loghook.csv</code> file and add entries for where you want to send the webhooks. The <a href="https://requestb.in/">RequestBin</a> tool is a great resource to use for setting up a quick and temporary webhook endpoint for testing.</p>

<p>I suggest creating a URL with RequestBin, then updating your <code class="highlighter-rouge">loghook.csv</code> file to look something like this:</p>

<pre><code class="language-csv">^example.example,http://example.com
.*,https://requestb.in/0ab12345
</code></pre>

<p>Once you do this, start up <code class="highlighter-rouge">loghook</code> by running this command:</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code>./loghook
</code></pre>
</div>

<p>You’ll know it’s working if you see output like this:</p>

<div class="language-console highlighter-rouge"><pre class="highlight"><code><span class="w">$ </span><span class="nc">./loghook</span><span class="kv">
</span>INFO[0000] Sending events matching '^example.example' to 'http://example.com'
INFO[0000] Sending events matching '.*' to 'https://requestb.in/0ab12345'
INFO[0000] Started polling for events at: https://dev-12345.oktapreview.com
</code></pre>
</div>

<p>I hope that this post has inspired you to think of cool ways you can use webhooks with your own Okta org. I highly suggest checking out <a href="https://zapier.com/">Zapier</a> and in particular the excellent <a href="https://zapier.com/blog/how-use-zapier-webhooks/">Zapier Webhook support</a> that Zapier provides. You should also take a look at this post on <a href="https://developer.okta.com/blog/2017/10/11/why-are-webhooks-better-than-serverless-extensibility">the webhooks vs serverless debate</a> by my friend and colleague Randall Degges.</p>

<p><a href="mailto:joel.franusic@okta.com">Let me know</a> how you’re using <code class="highlighter-rouge">loghook</code> or if you have any questions or comments about this post. And don’t forget to follow our team on Twitter <a href="https://twitter.com/OktaDev">@oktadev</a>. Thanks for reading!</p>


	</div>
	
</article>

		
</section>

		
	</div><footer class="Footer">
    <div class="Wrap">

        <div class="Row">

            <div class="Column--3 Column--medium-6 Column--xSmall-12">

                <a class="Logo" href="https://www.okta.com/" target="_blank" rel="noopener noreferrer">
                    <img src="https://developer.okta.com/sites/all/themes/developer/images/logo-footer.png" alt="Okta">
                    Visit okta.com
                </a>

            </div>

            <div class="Column--3 Column--medium-12 Column--xSmall-12">

                <h4>Social</h4>
                <ul class="Footer-links Footer-links--social">
                    <li><a class="Footer-links--github" target="_blank" rel="noopener noreferrer" href="http://github.com/oktadeveloper">Github</a></li>
                    <li><a class="Footer-links--twitter" target="_blank" rel="noopener noreferrer" href="http://twitter.com/OktaDev">Twitter</a></li>
                    <li><a class="Footer-links--forum" target="_blank" rel="noopener noreferrer" href="https://devforum.okta.com/">Forum</a></li>
                    <li><a class="Footer-links--rss" target="_blank" rel="noopener noreferrer" href="http://feeds.feedburner.com/OktaBlog">RSS Blog</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>More Info</h4>
                <ul class="Footer-links">
                    <li><a target="_blank" href="https://developer.okta.com/integrate-with-okta/">Integrate with Okta</a></li>
                    <li><a href="/blog/">Blog</a></li>
                    <li><a href="/docs/platform-release-notes/platform-release-notes.html">Release Notes</a></li>
                    <li><a href="/3rd_party_notices/">3rd Party Notices</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>Contact &amp; Legal</h4>
                <ul class="Footer-links">
                    <li><a href="/contact/">Contact Sales</a></li>
                    <li><a target="_blank" rel="noopener noreferrer" href="mailto:developers@okta.com">Contact Support</a></li>
                    <li><a href="/terms/">Terms &amp; Conditions</a></li>
                    <li><a href="/privacy/">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript" src="/assets/master-0365dd27cf276cb2a15c0a43906ca592538204cf1ad4557547bf4e50609b411e.js"></script>
    
    
    
    
      <script type="text/javascript" src="/assets/blog-6e32dad27404131cc8630a5282264bed2ab4c08c91ac86fa496b75c53aa4f681.js"></script>
    

  <!-- START Post Footer -->
  
  <!-- START Google Tag Manager -->
  <!-- https://support.google.com/tagmanager/answer/6103696?hl=en -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-TJ45R6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- END Google Tag Manager -->
  <!-- START Google Remarketing Tag -->
  <script type="text/javascript">
    /* <![CDATA[ */
    var google_conversion_id = 1006913831;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
    /* ]]> */
  </script>
  <div style="display:none;"><script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script></div>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"></div></noscript>
  <!-- END Google Remarketing Tag -->
  <!-- START Crazy Egg Tracking -->
  <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>
  <!-- END Crazy Egg Tracking -->

  <!-- END Post Footer -->
</body>
</html>
