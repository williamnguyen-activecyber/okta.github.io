<!doctype html>
<!--[if lt IE 7 ]> <html class="ie6 no-flexbox"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-flexbox"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-flexbox"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-flexbox"> <![endif]-->
<!--[if IE 10 ]>    <html class="ie10 no-flexbox"> <![endif]-->
<!--[if (gt IE 10)|!(IE)]><!--> <html class="modern wf-loading" lang="en"> <!--<![endif]-->
  <head>
  <script>
    var searchDomain = 'https://developer.okta.com';
    var isProduction = window.location.hostname === 'developer.okta.com';
    if (isProduction) {
      // TypeKit
      (function(d) {
        var config = {
          kitId: 'jff5neq',
          scriptTimeout: 3000,
          async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/bwf-loadingb/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
      })(document);

      // Google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-15777010-3', 'auto');
      ga('send', 'pageview');

      // START Google Tag Manager
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-TJ45R6');
      // END Google Tag Manager
    }
	</script>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
 	

  <link type="text/css" rel="stylesheet" href="https://developer.okta.com/sites/all/themes/developer/css/master.css" media="all" />
  <meta class="swiftype" name="title" data-type="string" content="User Authorization in ASP.NET Core with Okta | Okta Developer" />
  <meta class="swiftype" name="summary" data-type="string" content="Authorization is the oft-forgotten piece of identity and access management. The fact is, almost every app needs more than just “are they signed in?” for auth..." />

  <link type="text/css" rel="stylesheet" href="/assets/animate-ec43d72c3ed45e08a460b8a2966d8dba6006aebfa0530935c3973fa493a8771f.css">
  <link type="text/css" rel="stylesheet" href="/assets/okta-bdc44e64f3ccf409e81fcbd180b78cdc72901f2b97af69c18e6bb44dd908d3d2.css">
  
  
  <title>User Authorization in ASP.NET Core with Okta | Okta Developer</title>
  <meta name="description" content="Authorization is the oft-forgotten piece of identity and access management. The fact is, almost every app needs more than just “are they signed in?” for auth...">
  <link rel="canonical" href="https://developer.okta.com/blog/2017/10/04/aspnet-authorization">
  <link rel="alternate" type="application/rss+xml" title="Okta Developer" href="https://developer.okta.com/feed.xml"><!-- GA -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#21313a">
  <meta name="theme-color" content="#ffffff">
</head>

  
    <body id="blog">
	




<header class="Header is-fixed">

  <div class="Wrap">

    <a class="Logo" href="https://developer.okta.com">
      <svg version="1.1" id="OktaLogo" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 431.9 151.4" style="enable-background:new 0 0 431.9 151.4;" xml:space="preserve"><g><g><g><path d="M102.2,41.4c-21,0-38.1,17.1-38.1,38.1s17.1,38.1,38.1,38.1s38.1-17.1,38.1-38.1l0,0C140.3,58.5,123.2,41.4,102.2,41.4z M102.2,98.5c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19c0.1,10.5-8.4,19-18.9,19.1C102.3,98.6,102.2,98.6,102.2,98.5L102.2,98.5z"/><path d="M169.1,92.3c0-1.9,1.5-3.4,3.4-3.4c0.9,0,1.8,0.4,2.4,1c9.5,9.7,25.3,26.3,25.4,26.4c0.4,0.5,0.8,0.8,1.4,0.9l1.6,0.2h17.2c1.8,0,3.3-1.4,3.4-3.2c0-0.8-0.3-1.5-0.8-2.2l-28.6-29.2l-1.5-1.5c-3.2-3.9-2.9-5.4,0.8-9.3l22.6-25.1c1.1-1.4,0.8-3.5-0.6-4.6c-0.6-0.4-1.3-0.7-2-0.7h-17c-0.6,0.2-1.1,0.5-1.5,0.9L175,64.4c-1.3,1.4-3.4,1.5-4.8,0.2c-0.7-0.6-1.1-1.5-1.1-2.5V18.9c0-1.7-1.3-3-3-3c-0.1,0-0.2,0-0.3,0h-12.7c-2.2,0-3.3,1.5-3.3,2.8v95.8c0,2.2,1.8,2.8,3.3,2.8h12.7c1.7,0.1,3.2-1.2,3.3-2.9c0,0,0,0,0,0V92.3z"/><path d="M273,114l-1.4-12.8c-0.2-1.7-1.7-2.9-3.4-2.7c0,0,0,0-0.1,0l-2.9,0.2c-10.1,0-18.5-7.9-19-18c0-0.3,0-0.7,0-1V64.2c-0.1-2,1.5-3.6,3.5-3.7c0,0,0,0,0,0h17c1.7-0.1,3.1-1.5,3-3.2c0,0,0-0.1,0-0.1v-12c0-2.3-1.5-3.6-2.8-3.6h-17.1c-1.9,0.1-3.5-1.5-3.6-3.4c0,0,0,0,0,0V18.9c-0.1-1.7-1.5-3.1-3.2-3c0,0-0.1,0-0.1,0h-12.7c-1.6-0.1-3,1.1-3.1,2.7c0,0.1,0,0.1,0,0.2c0,0,0,61.7,0,62c0.5,21,17.9,37.6,38.9,37c1.4,0,2.9-0.2,4.3-0.3C272,117.2,273.2,115.7,273,114z"/></g><path d="M364.7,98c-10.8,0-12.4-3.8-12.4-18.3l0,0V44.8c0-1.8-1.4-3.2-3.2-3.2c0,0-0.1,0-0.1,0h-12.8c-1.8,0-3.2,1.4-3.3,3.2v1.6C314.6,36,291.3,42.5,281,60.8c-10.4,18.3-3.9,41.6,14.4,51.9c14,7.9,31.4,6.2,43.5-4.2c3.6,5.5,9.3,9.1,18.3,9.1c1.5,0,9.7,0.3,9.7-3.5v-13.6C367,99.2,366,98.1,364.7,98z M314.2,98.6c-10.5,0-19-8.5-19-19s8.5-19,19-19s19,8.5,19,19l0,0C333.2,90.1,324.7,98.6,314.2,98.6z"/></g><path d="M19.4,74c2.2-1.9,4.1-4.1,5.7-6.6c3.5-5.3,5.4-11.5,5.2-17.9V27c0-4.9,0.9-8.4,2.7-10.5c1.8-2.1,4.8-3,9.2-3h12.6c1.2,0,2.1-0.9,2.2-2.1l0,0V2.2C57,1,56,0,54.8,0c0,0,0,0,0,0H41.5c-7.8,0-12.9,2.1-18,7.6s-7.1,12.3-7.1,21.7v14.2c0,2.2-0.1,4-0.2,5.7v2.2c-0.5,3.2-1.8,6.2-3.6,8.9C9.4,64.7,5.1,70.9,0.9,74l0,0l-0.3,0.3l0,0l-0.2,0.3H0.2v0.3l0,0c-0.1,0.3-0.1,0.7,0,1l0,0v0.3h0.1l0.2,0.3l0,0l0.3,0.3l0,0c4.2,3.1,8.5,9.3,11.3,13.7c1.8,2.7,3.1,5.7,3.6,8.9v2.2c0.1,1.6,0.2,3.5,0.2,5.7v14.3c0,9.4,2.4,16.7,7.1,21.7s10.2,7.6,18,7.6h13.8c1.2,0,2.2-1,2.2-2.2V140l0,0c0-1.2-1-2.2-2.2-2.2H42.2c-4.4,0-7.5-1-9.2-3s-2.7-5.6-2.7-10.5v-22.4c0.2-6.4-1.7-12.6-5.2-17.9c-1.6-2.5-3.5-4.7-5.7-6.6l0,0c-0.9-0.7-1.1-2-0.4-2.9C19.2,74.3,19.3,74.2,19.4,74L19.4,74z"/><path d="M412.5,74c-2.2-1.9-4.1-4.1-5.7-6.6c-3.5-5.3-5.4-11.5-5.2-17.9V27c0-4.9-0.9-8.4-2.7-10.5s-4.8-3-9.2-3h-12.6c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0l0,0V2.2c0-1.2,1-2.2,2.2-2.2c0,0,0,0,0,0h13.4c7.8,0,12.9,2.1,18,7.6s7.1,12.3,7.1,21.7v14.2c0,2.2,0.1,4,0.2,5.7v2.2c0.5,3.2,1.8,6.2,3.6,8.9c2.8,4.5,7.1,10.7,11.3,13.7l0,0l0.3,0.3l0,0l0.2,0.3h0.1v0.3l0,0c0.1,0.3,0.1,0.7,0,1l0,0v0.3h-0.1l-0.2,0.3l0,0l-0.3,0.3l0,0c-4.2,3.1-8.5,9.3-11.3,13.7c-1.8,2.7-3.1,5.7-3.6,8.9v2.2c-0.1,1.6-0.2,3.5-0.2,5.7v14.3c0,9.4-2.4,16.7-7.1,21.7s-10.2,7.6-18,7.6h-13.4c-1.2,0-2.2-1-2.2-2.2c0,0,0,0,0,0V140l0,0c0-1.2,1-2.2,2.2-2.2l0,0h12.7c4.4,0,7.5-1,9.2-3s2.7-5.6,2.7-10.5v-22.4c-0.2-6.3,1.6-12.6,5.1-17.9c1.6-2.5,3.5-4.7,5.7-6.6l0,0c0.9-0.7,1.1-2,0.4-2.9C412.7,74.3,412.6,74.2,412.5,74L412.5,74z"/></g></svg>
    </a>

    <nav class="Header-nav PrimaryNav">
      <ul class="menu">
        <li class="first leaf">
          <a href="https://developer.okta.com/product/">Product</a>
        </li>
        <li class="leaf">
          <a href="https://developer.okta.com/pricing/">Pricing</a>
        </li>
        <li class="leaf">
          <a href="/blog/" class="active">Blog</a>
        </li>
        <li class="leaf">
          <a href="/documentation/">Docs</a>
        </li>
        <li class="last expanded">
          <span class="nolink">Support</span>
          <ul class="menu">
            <li class="first leaf"><a href="https://devforum.okta.com/">Okta Developer Forums</a></li>
            <li class="last leaf"><a href="mailto:developers@okta.com">developers@okta.com</a></li>
          </ul>
        </li>
      </ul>
      <a class="PrimaryNav-toggle" href="#">
        <svg width="20px" height="20px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <g class="MenuIcon" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" stroke-linecap="round">
                <path d="M1,16 L19,16" class="MenuIcon-line1" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,4 L19,4" class="MenuIcon-line2" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line3" stroke="#FFFFFF" stroke-width="2"></path>
                <path d="M1,10 L19,10" class="MenuIcon-line4" stroke="#FFFFFF" stroke-width="2"></path>
            </g>
        </svg>
        <svg class="CloseIcon" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <g id="ALl-Boards" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
            <g id="Desktop" transform="translate(-915.000000, -235.000000)" fill="#FFFFFF">
              <g id="Search-bar-Active" transform="translate(30.000000, 26.000000)">
                <polygon id="Icon/Cross" points="901 210.6 899.4 209 893 215.4 886.6 209 885 210.6 891.4 217 885 223.4 886.6 225 893 218.6 899.4 225 901 223.4 894.6 217"></polygon>
              </g>
            </g>
          </g>
        </svg>
      </a>

      <div class="PrimaryNav-cta">
        <a target="_blank" rel="noopener noreferrer" href="https://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3Dhttps://login.okta.com/?SAMLRequest=fc%2B7CsJAEAXQXvAflu1NNJUMeZBGELTx1a%2FrYILJTtyZGD%2FfSBRiYzlw77lMnD3rSj3Qc0ku0YtgrhU6S5fSXRN9PKxmS52l00nMpq6iBvJWCrfDe4ss6vStRe9aDzmGIZfo1jsgwyWDMzUyiIV9vt1AH4XGk5ClSvewUgMNa%2BYW%2FVj5jxhm9NLP67QQaSAMu64L6CYmsFSHlnzT4ZlLwTgcL6Sf8%2FeX9AU%3D" class="Button--redOutline">Login</a>
        <a href="https://developer.okta.com/signup/" class="Button--red">Sign up</a>
      </div>

      <a class="SearchIcon" href="#"></a>
      <form id="form_search" class="SearchBar Formisimo_clocked_69929" method="get" action="https://developer.okta.com/search/" name="form_search" __bizdiag="-784164280" __biza="WJ__">
        <input type="text" name="stq" autocomplete="off" id="st-search-input-auto" class="st-search-input" placeholder="Search">
        <input type="submit" name="submit" value="GO">
      </form>

    </nav>

  </div>

</header>

	<div class="page-content">
		






<section class="Blog is-single">
		
	<div class="Blog-social">
		
		<a href="https://github.com/leebrandt" target="_blank"><i class="fa fa-github"></i></a>
		
		
		<a href="https://twitter.com/leebrandt" target="_blank"><i class="fa fa-twitter"></i></a>
		
		
		
		<a href="http://leebrandt.me" target="_blank"><i class="fa fa-external-link"></i></a>
		
	</div>
	
	

<article class="BlogPost">
	
	<header class="BlogPost-header">
	
		<time class="BlogPost-date" datetime="2017-10-04">October 4, 2017</time>
		
		<h1 class="BlogPost-title">
			
			User Authorization in ASP.NET Core with Okta
			
		</h1>
		
		<div class="BlogPost-attribution">
			
				<img src="/assets/avatar-leebrandt-23a647548f26433d031856dcef1df5204763b94283cd68c397d816a61363a94d.jpg" alt="avatar-leebrandt.jpg" class="BlogPost-avatar">
			
			<span class="BlogPost-author">Lee Brandt</span>
		</div>
	
	</header>
	
	<div class="BlogPost-content">
		
	<p>Authorization is the oft-forgotten piece of identity and access management. The fact is, almost every app needs more than just “are they signed in?” for authorization. Most times, you need to not only know <em>who</em> “they” are, but what access they are supposed to have. For instance, “are they in the administrator group?” or “are they in a group with some special privileges?” Today, you’ll learn how to do this with Okta in an ASP.NET Core MVC application.</p>

<p>In the Okta world, users are separated into <code class="highlighter-rouge">Groups</code>. By default however, ASP.NET only has handling for the <code class="highlighter-rouge">Authorize</code> attribute to handle authorization using <code class="highlighter-rouge">Roles</code>. There are a couple of ways you could go about handling authorization using the <code class="highlighter-rouge">Groups</code> that come from Okta:</p>

<ul>
  <li>You can write your own custom <code class="highlighter-rouge">AuthorizeAttribute</code> and have it looks at groups instead of roles.</li>
  <li>You can map the <code class="highlighter-rouge">Groups</code> to <code class="highlighter-rouge">Roles</code> claims and let the regular ASP.NET <code class="highlighter-rouge">AuthorizeAttribute</code> handle authorization</li>
</ul>

<p>This second approach is far easier to implement, so that’s the approach this article will take.</p>

<p>Start by cloning the application at <a href="https://github.com/oktadeveloper/aspnetcore-oidc-okta-example">https://github.com/oktadeveloper/aspnetcore-oidc-okta-example</a>. This is the base application with authentication covered in <a href="https://developer.okta.com/blog/2017/06/29/oidc-user-auth-aspnet-core">my previous post</a>. You’ll add authorization to this application.</p>

<h2 id="let-aspnet-know-where-your-roles-are">Let ASP.NET Know Where Your Roles Are</h2>
<p>In the <code class="highlighter-rouge">startup.cs</code> file, where the <code class="highlighter-rouge">OpenIdConfigurationOptions</code> are set, one of the items being set is the <code class="highlighter-rouge">TokenValidationParameters</code>. In the new <code class="highlighter-rouge">TokenValidationParameters</code> add a property called <code class="highlighter-rouge">RoleClaimType</code> with a value of <code class="highlighter-rouge">ClaimTypes.Role</code>. This is an enumeration in the <code class="highlighter-rouge">System.Security.Claims</code> namespace that holds the URL that describes the “role” claim type. Ultimately, your <code class="highlighter-rouge">TokenValidationParameters</code> property should look like this.</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="n">TokenValidationParameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TokenValidationParameters</span>
<span class="p">{</span>
  <span class="n">ValidateIssuer</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
  <span class="n">RoleClaimType</span> <span class="p">=</span> <span class="n">ClaimTypes</span><span class="p">.</span><span class="n">Role</span>
<span class="p">}</span>
</code></pre>
</div>

<h2 id="add-a-claims-transformer">Add a Claims Transformer</h2>
<p>The <a href="https://docs.microsoft.com/en-us/aspnet/core/api/microsoft.aspnetcore.authentication.claimstransformer">Claims Tranformer</a> is a way to manipulate the <a href="https://msdn.microsoft.com/en-us/library/system.security.claims.claimsprincipal(v=vs.110).aspx">ClaimsPrincipal</a>, which is the main user in your ASP.NET application, once the user is authenticated.</p>

<p>Add a folder inside the <code class="highlighter-rouge">Domain</code> folder called <code class="highlighter-rouge">Authorization</code>. Then add a class called <code class="highlighter-rouge">GroupsToRolesTransformer</code>. The contents of the transformer should be:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Claims</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.AspNetCore.Authentication</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Okta.Sdk</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Okta.Sdk.Configuration</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">AspnetOkta.Domain.Authorization</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">class</span> <span class="nc">GroupsToRolesTransformer</span> <span class="p">:</span> <span class="n">IClaimsTransformer</span>
  <span class="p">{</span>
    <span class="k">private</span> <span class="n">OktaClient</span> <span class="n">client</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">GroupsToRolesTransformer</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">OktaClient</span><span class="p">(</span><span class="k">new</span> <span class="n">OktaClientConfiguration</span><span class="p">{</span>
            <span class="n">OrgUrl</span> <span class="p">=</span> <span class="s">"https://{Your Okta Org Url}"</span><span class="p">,</span>
            <span class="n">Token</span> <span class="p">=</span> <span class="s">"JiBBerJabbER"</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">ClaimsPrincipal</span><span class="p">&gt;</span> <span class="nf">TransformAsync</span><span class="p">(</span><span class="n">ClaimsTransformationContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="kt">var</span> <span class="n">idClaim</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="nf">FindFirst</span><span class="p">(</span><span class="n">x</span><span class="p">=&gt;</span><span class="n">x</span><span class="p">.</span><span class="n">Type</span> <span class="p">==</span> <span class="n">ClaimTypes</span><span class="p">.</span><span class="n">NameIdentifier</span><span class="p">);</span>
      <span class="k">if</span><span class="p">(</span><span class="n">idClaim</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="kt">var</span> <span class="n">user</span> <span class="p">=</span> <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">Users</span><span class="p">.</span><span class="nf">GetUserAsync</span><span class="p">(</span><span class="n">idClaim</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>
          <span class="k">if</span><span class="p">(</span><span class="n">user</span> <span class="p">!=</span> <span class="k">null</span><span class="p">){</span>
            <span class="kt">var</span> <span class="n">groups</span> <span class="p">=</span> <span class="n">user</span><span class="p">.</span><span class="n">Groups</span><span class="p">.</span><span class="nf">ToEnumerable</span><span class="p">();</span>
            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="k">group</span> <span class="k">in</span> <span class="n">groups</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="p">((</span><span class="n">ClaimsIdentity</span><span class="p">)</span><span class="n">context</span><span class="p">.</span><span class="n">Principal</span><span class="p">.</span><span class="n">Identity</span><span class="p">).</span><span class="nf">AddClaim</span><span class="p">(</span><span class="k">new</span> <span class="nf">Claim</span><span class="p">(</span><span class="n">ClaimTypes</span><span class="p">.</span><span class="n">Role</span><span class="p">,</span> <span class="k">group</span><span class="p">.</span><span class="n">Profile</span><span class="p">.</span><span class="n">Name</span><span class="p">));</span>
            <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">Principal</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>As you can see here, in the constructor, you are creating an <code class="highlighter-rouge">OktaClient</code> object to be stored in a class-level variable called client. You’ll need your <code class="highlighter-rouge">OrgUrl</code> from Okta (probably something like dev-1234.oktapreview.com) and an API token which you can get from the Okta Developer Dashboard under <code class="highlighter-rouge">API</code> &gt; <code class="highlighter-rouge">Tokens</code>.</p>

<p><img src="/assets/blog/aspnet-authz/tokens-ebf5ab3541082a5883161d08cca2433c9492c5590047a5e8593282816191c5e5.png" alt="API Token Page" width="800" /></p>

<p><em>Be aware that you only get to see the API token when you create it, so make sure you save it somewhere so you can reference it later.</em></p>

<p>Once you’ve created a transformer, it will implement the <code class="highlighter-rouge">IClaimsTransformer</code> interface. There is only one method you’ll need to worry about, and that’s the <code class="highlighter-rouge">TransformAsync</code> method. It takes a <code class="highlighter-rouge">ClaimsTransformationContext</code> and returns a <code class="highlighter-rouge">Task</code> with a <code class="highlighter-rouge">ClaimsPrincipal</code> in it.</p>

<p><em>Note that if you use the key shortcuts to get Visual Studio (or Visual Studio Code) to implement the interface for you, it will not add the <code class="highlighter-rouge">public</code> or <code class="highlighter-rouge">async</code> keywords to the signature. You’ll have to add them manually.</em></p>

<p>In this method, you’ll get the currently authenticated user’s <code class="highlighter-rouge">NameIdentifier</code> property. This is the ID you’ll use to get the Okta user so that you can get their groups. Just a quick null check for the <code class="highlighter-rouge">idClaim</code> variable and then go and get the <code class="highlighter-rouge">Groups</code> from the <code class="highlighter-rouge">user</code> object. From there, simply loop through the <code class="highlighter-rouge">Groups</code> and add a <code class="highlighter-rouge">Claim</code> using the <code class="highlighter-rouge">ClaimTypes.Role</code> enumeration and using the <code class="highlighter-rouge">group.Profile.Name</code> for the value of the claim.</p>

<p>Return the context.Principal no matter what. If you didn’t find the user’s identifier, or get a user back from the <code class="highlighter-rouge">GetUserAsync</code> call, at least the application will still get the <code class="highlighter-rouge">ClaimsPrincipal</code> back into the flow of the application.</p>

<h2 id="tell-the-application-to-use-your-transformer">Tell the Application to Use Your Transformer</h2>
<p>The only thing left is to configure your application to use the new transformer in your middleware pipeline.</p>

<p>Right below the OIDC setup in the <code class="highlighter-rouge">Configure</code> method of your <code class="highlighter-rouge">startup.cs</code> file, add the following code:</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code><span class="n">app</span><span class="p">.</span><span class="nf">UseClaimsTransformation</span><span class="p">(</span><span class="k">new</span> <span class="n">ClaimsTransformationOptions</span><span class="p">{</span>
  <span class="n">Transformer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">GroupsToRolesTransformer</span><span class="p">()</span>
<span class="p">});</span>
</code></pre>
</div>
<p>This tells the application that you want to transform the claims and which claims transformer you want to use.</p>

<h2 id="prove-that-it-works">Prove that it Works</h2>
<p>You’ll need to set up two users in two different groups in your Okta Developer Dashboard, call one group “Admin” and the other “Enthusiast”.</p>

<p><img src="/assets/blog/aspnet-authz/add-groups-e0e4bc990f21c1fc15ab0584658b06e25fac3a2a4db97ff6e7f2856e865c68ca.png" alt="Add Groups Page" width="800" /></p>

<p>Make sure the groups are assigned to your application:</p>

<p><img src="/assets/blog/aspnet-authz/group-assignments-c84e82bcf1a7677c028cb4e146e91aea155d3437a6cdabd1f85bc4dc2611ff72.png" alt="Assing Groups To Application" width="800" /></p>

<p>Then create some routes in the <code class="highlighter-rouge">UserController</code> decorated with the <code class="highlighter-rouge">AuthorizeAttribute</code>.</p>

<div class="language-csharp highlighter-rouge"><pre class="highlight"><code>  <span class="p">[</span><span class="nf">Authorize</span><span class="p">(</span><span class="n">Roles</span> <span class="p">=</span> <span class="s">"Admin"</span><span class="p">)]</span>
  <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">AdminOnly</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="p">[</span><span class="nf">Authorize</span><span class="p">(</span><span class="n">Roles</span> <span class="p">=</span> <span class="s">"Enthusiast"</span><span class="p">)]</span>
  <span class="k">public</span> <span class="n">IActionResult</span> <span class="nf">EnthusiastOnly</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="nf">View</span><span class="p">();</span>
  <span class="p">}</span>
</code></pre>
</div>

<p>Then create matching views for those routes.</p>

<p><em>AdminOnly.cshtml</em></p>
<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Admin Dashboard<span class="nt">&lt;/h1&gt;</span>
</code></pre>
</div>

<p><em>EnthusiastOnly.cshtml</em></p>
<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Enthusiast Dashboard<span class="nt">&lt;/h1&gt;</span>
</code></pre>
</div>

<p>Now you should be able to run your application, log in as a user in the “Admin” group, and go to the <a href="http://localhost:5000/User/AdminOnly">http://localhost:5000/User/AdminOnly</a> route successfully. The <code class="highlighter-rouge">EnthusiastOnly</code> route should return an unauthorized error.</p>

<p>Log back out and log in as a member of the “Enthusiast” group and go to the <a href="http://localhost:5000/User/EnthusiastOnly">http://localhost:5000/User/EnthusiastOnly</a> URL, and you should be able to get to it.</p>

<p>Congratulations! You just added authorization to you .NET application! Not only can users get into your application, but you can make sure they have access to the data and functionality they need!</p>

<h2 id="learn-more">Learn More</h2>
<p>You can learn more about the .NET  Claims Tranformer at <a href="https://docs.microsoft.com/en-us/aspnet/core/api/microsoft.aspnetcore.authentication.claimstransformer">https://docs.microsoft.com/en-us/aspnet/core/api/microsoft.aspnetcore.authentication.claimstransformer</a> and the broader spectrum of security in .NET at <a href="https://docs.microsoft.com/en-us/aspnet/core/security/">https://docs.microsoft.com/en-us/aspnet/core/security/</a>.</p>

<p>And don’t forget, <a href="https://developer.okta.com">Okta</a> can help you make user management simple! Sign up for a free forever developer account at <a href="https://developer.okta.com">https://developer.okta.com</a>! As always, if you have questions about anything here, feel free to reach out on Twitter <a href="https://twitter.com/leebrandt">https://twitter.com/leebrandt</a> or email me at <a href="mailto:lee.brandt@okta.com">lee.brandt@okta.com</a>.</p>


	</div>
	
</article>

		
</section>

		
	</div><footer class="Footer">
    <div class="Wrap">

        <div class="Row">

            <div class="Column--3 Column--medium-6 Column--xSmall-12">

                <a class="Logo" href="https://www.okta.com/" target="_blank" rel="noopener noreferrer">
                    <img src="https://developer.okta.com/sites/all/themes/developer/images/logo-footer.png" alt="Okta">
                    Visit okta.com
                </a>

            </div>

            <div class="Column--3 Column--medium-12 Column--xSmall-12">

                <h4>Social</h4>
                <ul class="Footer-links Footer-links--social">
                    <li><a class="Footer-links--github" target="_blank" rel="noopener noreferrer" href="http://github.com/oktadeveloper">Github</a></li>
                    <li><a class="Footer-links--twitter" target="_blank" rel="noopener noreferrer" href="http://twitter.com/OktaDev">Twitter</a></li>
                    <li><a class="Footer-links--forum" target="_blank" rel="noopener noreferrer" href="https://devforum.okta.com/">Forum</a></li>
                    <li><a class="Footer-links--rss" target="_blank" rel="noopener noreferrer" href="http://feeds.feedburner.com/OktaBlog">RSS Blog</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>More Info</h4>
                <ul class="Footer-links">
                    <li><a target="_blank" href="https://developer.okta.com/integrate-with-okta/">Integrate with Okta</a></li>
                    <li><a href="/blog/">Blog</a></li>
                    <li><a href="/docs/platform-release-notes/platform-release-notes.html">Release Notes</a></li>
                    <li><a href="/3rd_party_notices/">3rd Party Notices</a></li>
                </ul>
            </div>

            <div class="Column--3 Column--medium-6 Column--small-12">
                <h4>Contact &amp; Legal</h4>
                <ul class="Footer-links">
                    <li><a href="/contact/">Contact Sales</a></li>
                    <li><a target="_blank" rel="noopener noreferrer" href="mailto:developers@okta.com">Contact Support</a></li>
                    <li><a href="/terms/">Terms &amp; Conditions</a></li>
                    <li><a href="/privacy/">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript" src="/assets/master-0365dd27cf276cb2a15c0a43906ca592538204cf1ad4557547bf4e50609b411e.js"></script>
    
    
    
    
      <script type="text/javascript" src="/assets/blog-6e32dad27404131cc8630a5282264bed2ab4c08c91ac86fa496b75c53aa4f681.js"></script>
    

  <!-- START Post Footer -->
  
  <!-- START Google Tag Manager -->
  <!-- https://support.google.com/tagmanager/answer/6103696?hl=en -->
  <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-TJ45R6" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- END Google Tag Manager -->
  <!-- START Google Remarketing Tag -->
  <script type="text/javascript">
    /* <![CDATA[ */
    var google_conversion_id = 1006913831;
    var google_custom_params = window.google_tag_params;
    var google_remarketing_only = true;
    /* ]]> */
  </script>
  <div style="display:none;"><script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js"></script></div>
  <noscript><div style="display:inline;"><img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1006913831/?value=0&amp;guid=ON&amp;script=0"></div></noscript>
  <!-- END Google Remarketing Tag -->
  <!-- START Crazy Egg Tracking -->
  <script type="text/javascript">
    setTimeout(function(){var a=document.createElement("script");
    var b=document.getElementsByTagName("script")[0];
    a.src=document.location.protocol+"//script.crazyegg.com/pages/scripts/0021/9333.js?"+Math.floor(new Date().getTime()/3600000);
    a.async=true;a.type="text/javascript";b.parentNode.insertBefore(a,b)}, 1);
  </script>
  <!-- END Crazy Egg Tracking -->

  <!-- END Post Footer -->
</body>
</html>
